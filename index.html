<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Gerar usuário — Realtime DB</title>
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --bg: #0b0b0d;
                --card: #121215;
                --card-2: #17171b;
                --stroke: #24242a;
                --text: #e7e7ea;
                --muted: #a9a9b5;
                --primary: #ef233c; /* vermelho principal */
                --primary-2: #b3001b; /* vermelho escuro */
                --ring: rgba(239, 35, 60, 0.45);
                --ok: #22c55e;
                --warn: #f59e0b;
                --err: #ef4444;
                --radius: 14px;
                --shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
            }
            * {
                box-sizing: border-box;
            }
            html,
            body {
                height: 100%;
            }
            body {
                margin: 0;
                font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto,
                    Arial, sans-serif;
                color: var(--text);
                background: radial-gradient(
                        1200px 600px at 80% -40%,
                        rgba(239, 35, 60, 0.15),
                        transparent 60%
                    ),
                    radial-gradient(
                        900px 500px at -10% -30%,
                        rgba(239, 35, 60, 0.1),
                        transparent 60%
                    ),
                    var(--bg);
            }
            body.locked .wrap {
                filter: blur(1.5px);
                pointer-events: none;
                user-select: none;
            }
            .wrap {
                max-width: 980px;
                margin: 48px auto;
                padding: 0 20px 56px;
            }
            header {
                display: flex;
                align-items: center;
                gap: 14px;
                margin-bottom: 22px;
            }
            .badge {
                display: inline-grid;
                place-items: center;
                width: 40px;
                height: 40px;
                border-radius: 12px;
                background: linear-gradient(
                    145deg,
                    var(--primary),
                    var(--primary-2)
                );
                color: #fff;
                font-weight: 800;
                box-shadow: var(--shadow);
            }
            h1 {
                font-size: clamp(22px, 2.5vw, 28px);
                margin: 0 0 4px;
                font-weight: 800;
                letter-spacing: 0.2px;
            }
            .sub {
                color: var(--muted);
                font-size: 14px;
            }

            .card {
                background: linear-gradient(180deg, var(--card), var(--card-2));
                border: 1px solid var(--stroke);
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                padding: 22px;
            }
            .grid {
                display: grid;
                gap: 16px;
                grid-template-columns: 1fr;
            }
            @media (min-width: 760px) {
                .grid {
                    grid-template-columns: 1.2fr 0.8fr;
                }
            }

            .field {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            label {
                font-size: 13px;
                color: var(--muted);
            }
            input[type='text'],
            input[type='password'] {
                width: 100%;
                background: #0f0f12;
                border: 1px solid var(--stroke);
                color: var(--text);
                border-radius: 12px;
                padding: 14px 14px;
                outline: none;
                transition: 0.2s border, 0.2s box-shadow, 0.2s transform;
            }
            input:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 4px var(--ring);
                transform: translateY(-1px);
            }

            .pill-group {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }
            .pill {
                position: relative;
                border: 1px solid var(--stroke);
                color: var(--text);
                background: #0f0f12;
                padding: 10px 14px;
                border-radius: 999px;
                cursor: pointer;
                user-select: none;
                font-size: 14px;
                transition: border 0.2s, transform 0.2s;
            }
            .pill:hover {
                transform: translateY(-1px);
            }
            .pill input {
                position: absolute;
                inset: 0;
                opacity: 0;
                cursor: pointer;
            }
            .pill.active {
                border-color: var(--primary);
                box-shadow: 0 0 0 4px var(--ring) inset;
            }

            .actions {
                display: flex;
                align-items: center;
                gap: 12px;
                flex-wrap: wrap;
            }
            button.primary {
                border: 0;
                cursor: pointer;
                color: #fff;
                font-weight: 700;
                padding: 14px 18px;
                border-radius: 12px;
                letter-spacing: 0.2px;
                background: linear-gradient(
                    135deg,
                    var(--primary),
                    #ff3552 60%,
                    var(--primary)
                );
                box-shadow: 0 10px 18px rgba(239, 35, 60, 0.35);
                transition: transform 0.15s ease, box-shadow 0.2s ease,
                    filter 0.2s ease;
            }
            button.primary:hover {
                transform: translateY(-1px);
                filter: saturate(1.05);
            }
            button.primary:active {
                transform: translateY(0) scale(0.99);
            }
            button[disabled] {
                opacity: 0.6;
                cursor: not-allowed;
                filter: grayscale(0.2);
            }

            .muted {
                color: var(--muted);
                font-size: 13px;
            }
            .note {
                font-size: 12px;
                color: var(--muted);
            }

            .out {
                background: #0e0e11;
                border: 1px dashed #2a2a31;
                border-radius: 12px;
                padding: 14px;
                white-space: pre-wrap;
                min-height: 52px;
                font-family: ui-monospace, SFMono-Regular, Menlo, Consolas,
                    monospace;
            }

            .toast {
                position: fixed;
                right: 18px;
                bottom: 18px;
                z-index: 9999;
                background: #121216;
                color: #fff;
                border: 1px solid var(--stroke);
                border-left: 6px solid var(--primary);
                padding: 14px 16px;
                border-radius: 12px;
                box-shadow: var(--shadow);
                opacity: 0;
                transform: translateY(10px);
                transition: 0.25s;
            }
            .toast.show {
                opacity: 1;
                transform: translateY(0);
            }
            .key-copy {
                display: inline-flex;
                gap: 8px;
                align-items: center;
            }
            .key-chip {
                background: #19191f;
                border: 1px solid var(--stroke);
                padding: 6px 10px;
                border-radius: 10px;
                font-family: ui-monospace, SFMono-Regular, Menlo, Consolas,
                    monospace;
                font-size: 12px;
            }
            .copy-btn {
                border: 1px solid var(--stroke);
                background: transparent;
                color: var(--text);
                padding: 6px 10px;
                border-radius: 10px;
                cursor: pointer;
                font-size: 12px;
            }

            /* ===== Overlay (portão) ===== */
            #gate {
                position: fixed;
                inset: 0;
                z-index: 99999;
                display: grid;
                place-items: center;
                background: radial-gradient(
                        1000px 500px at 70% -20%,
                        rgba(239, 35, 60, 0.1),
                        transparent 60%
                    ),
                    rgba(8, 8, 10, 0.88);
                backdrop-filter: blur(3px);
            }
            .gate-card {
                width: min(92vw, 420px);
                background: linear-gradient(180deg, var(--card), var(--card-2));
                border: 1px solid var(--stroke);
                border-radius: 16px;
                box-shadow: var(--shadow);
                padding: 22px;
            }
            .gate-title {
                margin: 0 0 8px;
                font-weight: 800;
            }
            .gate-sub {
                color: var(--muted);
                font-size: 13px;
                margin-bottom: 14px;
            }
            .gate-row {
                display: flex;
                gap: 10px;
            }
            .gate-row input {
                flex: 1;
                background: #0f0f12;
                color: var(--text);
                border: 1px solid var(--stroke);
                border-radius: 12px;
                padding: 12px 12px;
            }
            .gate-row button {
                white-space: nowrap;
                border: 0;
                border-radius: 12px;
                padding: 12px 14px;
                color: #fff;
                cursor: pointer;
                background: linear-gradient(
                    135deg,
                    var(--primary),
                    #ff3552 60%,
                    var(--primary)
                );
                box-shadow: 0 10px 18px rgba(239, 35, 60, 0.35);
            }
            .gate-hint {
                margin-top: 10px;
                font-size: 12px;
                color: var(--muted);
            }
        </style>
    </head>
    <body class="locked">
        <div class="wrap">
            <header>
                <div class="badge">✓</div>
                <div>
                    <h1>Gerar usuário no Cheat Android</h1>
                    <div class="sub">Projeto do cliente — Combo Xereca 🔥</div>
                </div>
            </header>

            <div class="card">
                <div class="grid">
                    <section
                        style="display: flex; flex-direction: column; gap: 14px"
                    >
                        <div class="field">
                            <label for="usuario">Usuário</label>
                            <input
                                id="usuario"
                                type="text"
                                placeholder="ex: seuusuario"
                                value="herbert-test"
                            />
                        </div>
                        <div class="field">
                            <label for="senha">Senha</label>
                            <input
                                id="senha"
                                type="text"
                                placeholder="ex: senha123"
                                value="teste123"
                            />
                            <div class="note">
                                Evite repetir uma senha que já exista no banco —
                                o app costuma filtrar por esse campo.
                            </div>
                        </div>

                        <div class="field">
                            <label>Acessos</label>
                            <div class="pill-group" id="acessos">
                                <label class="pill active"
                                    ><input
                                        type="radio"
                                        name="acc"
                                        value="1"
                                        checked
                                    />01 acesso</label
                                >
                                <label class="pill"
                                    ><input
                                        type="radio"
                                        name="acc"
                                        value="2"
                                    />02 acessos</label
                                >
                                <label class="pill"
                                    ><input
                                        type="radio"
                                        name="acc"
                                        value="Ilimitado"
                                    />Ilimitado</label
                                >
                            </div>
                        </div>

                        <div class="actions">
                            <button class="primary" id="go">
                                <span id="btnText">Criar usuário</span>
                            </button>
                            <span class="muted"
                                >Será criado um registro em
                                <code>/Login/UserKey-[timestamp]</code>.</span
                            >
                        </div>
                    </section>

                    <section
                        style="display: flex; flex-direction: column; gap: 12px"
                    >
                        <label>Resposta</label>
                        <pre class="out" id="out"></pre>
                        <div class="key-copy" id="keyBox" style="display: none">
                            <span class="key-chip" id="keyChip"></span>
                            <button class="copy-btn" id="copyKey">
                                Copiar key
                            </button>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <!-- ===== Overlay (Portão de senha) ===== -->
        <div id="gate" role="dialog" aria-modal="true">
            <div class="gate-card">
                <h3 class="gate-title">Acesso restrito</h3>
                <div class="gate-sub">
                    Digite a senha de administrador para continuar.
                </div>
                <div class="gate-row">
                    <input
                        id="gatePwd"
                        type="password"
                        placeholder="Senha de administrador"
                        autocomplete="off"
                    />
                    <button id="gateBtn">Entrar</button>
                </div>
                <div class="gate-hint">Dica: a senha tem 8 caracteres...</div>
            </div>
        </div>

        <div class="toast" id="toast"></div>

        <script>
            // =======================
            // PORTÃO / ANTI-BYPASS LIGHT
            // =======================
            (function () {
                // hash SHA-256 de "admin123"
                const H =
                    '240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9';
                let UNLOCKED = false;
                // BASE só é definida após desbloqueio
                let BASE = null;

                const $ = (q) => document.querySelector(q);
                const gate = $('#gate');
                const gatePwd = $('#gatePwd');
                const gateBtn = $('#gateBtn');

                async function sha256Hex(str) {
                    const d = new TextEncoder().encode(str);
                    const h = await crypto.subtle.digest('SHA-256', d);
                    return [...new Uint8Array(h)]
                        .map((b) => b.toString(16).padStart(2, '0'))
                        .join('');
                }

                async function tryUnlock() {
                    const v = gatePwd.value || '';
                    const ok = (await sha256Hex(v)) === H;
                    if (!ok) {
                        gatePwd.value = '';
                        gatePwd.focus();
                        showToast('Senha incorreta.', 'err');
                        return;
                    }
                    UNLOCKED = true;
                    // Define BASE somente agora
                    BASE = 'https://combo-b7d6a-default-rtdb.firebaseio.com';
                    document.body.classList.remove('locked');
                    gate.style.display = 'none';
                    showToast('Acesso liberado.', 'ok');
                    // expõe de forma controlada a outras funções
                    window.__APP_UNLOCK__ = () => UNLOCKED;
                    window.__APP_BASE__ = () => BASE;
                }

                gateBtn.addEventListener('click', tryUnlock);
                gatePwd.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') tryUnlock();
                });
                gatePwd.focus();

                // Se alguém remover o #gate no inspetor sem desbloquear, recarrega.
                const mo = new MutationObserver(() => {
                    if (!UNLOCKED) {
                        if (!document.getElementById('gate')) {
                            location.reload();
                        }
                    }
                });
                mo.observe(document.body, { childList: true, subtree: true });

                // Bloqueios leves (não impedem, mas atrapalham):
                document.addEventListener(
                    'contextmenu',
                    (e) => {
                        if (!UNLOCKED) e.preventDefault();
                    },
                    { capture: true }
                );
                document.addEventListener(
                    'keydown',
                    (e) => {
                        if (
                            !UNLOCKED &&
                            (e.ctrlKey || e.metaKey) &&
                            ['u', 's', 'c', 'i', 'j'].includes(
                                e.key.toLowerCase()
                            )
                        ) {
                            e.preventDefault();
                        }
                    },
                    { capture: true }
                );

                // ============== RESTO DA APP ==============
                // UI helpers
                const out = $('#out'),
                    btn = $('#go'),
                    btnText = $('#btnText'),
                    toast = $('#toast');
                const keyBox = $('#keyBox'),
                    keyChip = $('#keyChip'),
                    copyKeyBtn = $('#copyKey');

                // Estilo ativo nos pills de "Acessos"
                document
                    .querySelectorAll('#acessos .pill input')
                    .forEach((i) => {
                        i.addEventListener('change', () => {
                            document
                                .querySelectorAll('#acessos .pill')
                                .forEach((p) => p.classList.remove('active'));
                            i.parentElement.classList.add('active');
                        });
                    });

                function showToast(msg, type = 'ok') {
                    toast.textContent = msg;
                    toast.style.borderLeftColor =
                        type === 'ok'
                            ? 'var(--ok)'
                            : type === 'warn'
                            ? 'var(--warn)'
                            : 'var(--err)';
                    toast.classList.add('show');
                    setTimeout(() => toast.classList.remove('show'), 3000);
                }
                window.showToast = showToast; // usado acima no portão

                function nowBR() {
                    const d = new Date();
                    const fmt = new Intl.DateTimeFormat('pt-BR', {
                        timeZone: 'America/Sao_Paulo',
                        hour12: false,
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                    });
                    const parts = Object.fromEntries(
                        fmt.formatToParts(d).map((p) => [p.type, p.value])
                    );
                    return `${parts.day}/${parts.month}/${parts.year}, ${parts.hour}:${parts.minute}:${parts.second}`;
                }

                async function senhaJaExiste(senha) {
                    const base = window.__APP_BASE__ && window.__APP_BASE__();
                    if (!UNLOCKED || !base) throw new Error('Bloqueado.');
                    const q = `${base}/Login.json?orderBy=%22Senha%22&equalTo=%22${encodeURIComponent(
                        senha
                    )}%22`;
                    const res = await fetch(q, { cache: 'no-store' });
                    if (!res.ok) return false;
                    const data = await res.json();
                    return data && Object.keys(data).length > 0;
                }

                function setLoading(v) {
                    btn.disabled = v || !UNLOCKED;
                    btnText.textContent = v ? 'Gerando...' : 'Criar usuário';
                }

                copyKeyBtn.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(
                            keyChip.textContent
                        );
                        showToast('Key copiada!', 'ok');
                    } catch {
                        showToast('Não consegui copiar :(', 'err');
                    }
                });

                $('#go').addEventListener('click', async () => {
                    if (!UNLOCKED) {
                        showToast('Acesso bloqueado. Informe a senha.', 'warn');
                        return;
                    }
                    const base = window.__APP_BASE__ && window.__APP_BASE__();
                    if (!base) {
                        showToast('Configuração indisponível.', 'err');
                        return;
                    }

                    const usuario = $('#usuario').value.trim();
                    const senha = $('#senha').value.trim();
                    const acessos = document.querySelector(
                        'input[name="acc"]:checked'
                    ).value;

                    out.textContent = '';
                    keyBox.style.display = 'none';

                    if (!usuario || !senha) {
                        showToast('Informe usuário e senha.', 'warn');
                        return;
                    }

                    try {
                        setLoading(true);

                        if (await senhaJaExiste(senha)) {
                            showToast(
                                `Já existe um registro com a senha "${senha}".`,
                                'warn'
                            );
                            setLoading(false);
                            return;
                        }

                        const ts = Date.now();
                        const key = `UserKey-${ts}`;

                        const payload = {
                            Acessos: String(acessos),
                            Cargo: 'USER',
                            Data: nowBR(),
                            Distribuidor: 'ADM',
                            Key: key,
                            Saldo: '5',
                            Senha: senha,
                            Status: 'Ativo',
                            Timer: String(ts), // importante para o app
                            UID: '',
                            UID2: '',
                            Usuario: usuario,
                        };

                        const url = `${base}/Login/${key}.json`;
                        const res = await fetch(url, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Cache-Control': 'no-cache',
                            },
                            body: JSON.stringify(payload),
                        });

                        if (!res.ok) {
                            const txt = await res.text();
                            throw new Error(`HTTP ${res.status} — ${txt}`);
                        }

                        const json = await res.json();
                        out.textContent = JSON.stringify(
                            { key, payload: json },
                            null,
                            2
                        );

                        keyChip.textContent = key;
                        keyBox.style.display = 'inline-flex';
                        showToast('Usuário criado com sucesso!', 'ok');
                    } catch (err) {
                        out.textContent =
                            '❌ Erro: ' + (err?.message || String(err));
                        showToast('Erro ao criar usuário.', 'err');
                    } finally {
                        setLoading(false);
                    }
                });
            })();
        </script>
    </body>
</html>
